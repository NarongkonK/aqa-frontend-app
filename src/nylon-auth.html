<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/jwt-decode/jwt-decode.html">

<script>
  class NylonAuth extends Polymer.Element {

    static get is() { return 'nylon-auth'; }
    static get template() {
      return Polymer.html`
        <iframe id="authIframe" src="[[_url(path)]]" style="position: absolute; width: 1px; height: 1px; left: -9999px; display: none;" on-error="testza"></iframe>
      `
    }

    static get properties() {
      return {
        baseUrl: {
          type: String,
          value: 'http://localhost:5000/api/auth'
        },
        path: {
          type: String,
          value: "/scan"
        },
        userInfo: {
          notify: true,
          type: Object,
          value: function(){
            return {}
          }
        },
        disabled: Boolean
      }
    }

    ready() {
      super.ready()
      window.addEventListener("message", this._message.bind(this), false);
      if(this.disabled){
        this.dispatchEvent(new CustomEvent('disabled'));
      }
     
    }

    checkRule() {
      console.log('checkRule')
    }

    _message(event) {
      let topic = event.data.split('?')[0]

      switch (topic) {
        case 'nylonAuth/auth':
        
          let token = this.getParameterByName('accessToken',event.data)
          axios.defaults.headers.common['Authorization'] = token

          let decoded = jwt_decode(token);
          this.userInfo = decoded
          this.dispatchEvent(new CustomEvent('auth', {detail: decoded}));

          
          axios.get(this.baseUrl+'/checkToken')
          .then((res)=>{
            console.log(res.data)
          })

          console.log('ccc')
          axios.get('/auth/user')
          .then((res)=>{
            console.log(res.data)
          })


          break;
        case 'nylonAuth/noauth':
            axios.defaults.headers.common['Authorization'] = ''
            this.dispatchEvent(new CustomEvent('noauth'));
            break;
        default:
            console.log('xx')
      }

      // if(topic=='nylonAuth/auth'){
      //   console.log(this.getParameterByName('accessToken',event.data))
      // }
    }

    _url(path) {
      return this.baseUrl + this.path
    }


    getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    testza(){
      console.log('errorxx')
    }


  }

  window.customElements.define(NylonAuth.is, NylonAuth);
</script>